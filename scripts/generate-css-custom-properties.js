#!/usr/bin/env node
/**
 * Generate CSS Custom Properties from LESS Variables
 *
 * This script reads all LESS variable files in static/css/less/,
 * extracts the variables, and generates a CSS file with CSS custom properties.
 *
 * Usage: node scripts/generate-css-custom-properties.js
 *
 * TODO: Remove this script once we have deprecated LESS.
 */

const fs = require('fs');
const path = require('path');
const less = require('less');

const LESS_DIR = path.resolve(__dirname, '../static/css/less');
const OUTPUT_FILE = path.resolve(LESS_DIR, 'generated-custom-properties.css');
const OUTPUT_FILENAME = path.basename(OUTPUT_FILE);

/**
 * Get all LESS files from the directory
 * Uses path module for cross-platform compatibility (Windows/Mac/Linux)
 */
function getLessFiles() {
    const files = fs.readdirSync(LESS_DIR)
        .filter(file => {
            // Only include .less files, exclude the generated output
            const ext = path.extname(file).toLowerCase();
            return ext === '.less' && file !== OUTPUT_FILENAME;
        })
        .sort(); // Sort alphabetically for consistent ordering

    return files;
}

/**
 * Extract variable definitions from LESS content
 * Returns array of { name, value } objects
 */
function extractVariables(content) {
    const variables = [];
    // Match @variable-name: value; patterns
    // Uses [\s\S] instead of . to handle multi-line values (like font stacks)
    const varRegex = /^@([\w-]+):\s*([\s\S]+?);/gm;

    let match;
    while ((match = varRegex.exec(content)) !== null) {
        const name = match[1];
        // Normalize whitespace in multi-line values
        const value = match[2].trim().replace(/\s+/g, ' ');
        variables.push({ name, value });
    }

    return variables;
}

/**
 * Convert a LESS variable name to a CSS custom property name
 * @variable-name -> --variable-name
 */
function toCssPropertyName(lessVarName) {
    return `--${lessVarName}`;
}

async function main() {
    console.log('Generating CSS custom properties from LESS variables...\n');

    const lessFiles = getLessFiles();
    console.log(`Found ${lessFiles.length} LESS files in ${path.basename(LESS_DIR)}/\n`);

    // Collect all variables from all files
    const allVariables = [];

    for (const filename of lessFiles) {
        const filepath = path.join(LESS_DIR, filename);
        if (!fs.existsSync(filepath)) {
            console.warn(`Warning: ${filename} not found, skipping.`);
            continue;
        }

        const content = fs.readFileSync(filepath, 'utf8');
        const variables = extractVariables(content);

        console.log(`  ${filename}: ${variables.length} variables`);
        allVariables.push(...variables);
    }

    console.log(`\nTotal variables found: ${allVariables.length}`);

    // Build a LESS source that imports all variables and outputs them as CSS custom properties
    let lessSource = '// Auto-generated LESS source for CSS custom properties\n\n';

    // Import all the variable files first
    for (const filename of lessFiles) {
        lessSource += `@import "${filename}";\n`;
    }

    lessSource += '\n:root {\n';

    for (const { name } of allVariables) {
        // Reference the LESS variable to get its resolved value
        lessSource += `  ${toCssPropertyName(name)}: @${name};\n`;
    }

    lessSource += '}\n';

    // Compile with Less to resolve all variable references
    try {
        const output = await less.render(lessSource, {
            paths: [LESS_DIR],
            compress: false,
        });

        // Extract just the :root block (removes LESS comments from imported files)
        let css = output.css;
        const rootMatch = css.match(/:root\s*\{[\s\S]*?\n\}/);
        if (rootMatch) {
            css = rootMatch[0];
        }

        // Add a header comment
        const header = `/**
 * CSS Custom Properties
 * ======================
 * Auto-generated from LESS variables in static/css/less/
 *
 * DO NOT EDIT THIS FILE DIRECTLY!
 * Run: node scripts/generate-css-custom-properties.js
 *
 */

`;
        css = header + css;

        // Write the output file
        fs.writeFileSync(OUTPUT_FILE, css, 'utf8');
        console.log(`\nGenerated: ${path.relative(process.cwd(), OUTPUT_FILE)}`);
        console.log('Done!');

    } catch (error) {
        console.error('Error compiling LESS:', error.message);
        if (error.line) {
            console.error(`  Line ${error.line}: ${error.extract?.join('\n  ')}`);
        }
        process.exit(1);
    }
}

main();
