name: Issue PM AI

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write

jobs:
  respond:
    # Only run for issues opened in the main repository (not forks)
    if: github.repository == 'internetarchive/openlibrary'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - name: Load PM AI Instructions
        id: pm
        run: |
          {
            echo "INSTRUCTIONS<<EOF"
            cat .github/prompts/issue_pm_instructions.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Generate issue response (GitHub Models)
        id: generate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          INSTRUCTIONS: ${{ steps.pm.outputs.INSTRUCTIONS }}
        run: |
          # Escape special characters for JSON
          ESCAPED_INSTRUCTIONS=$(echo "$INSTRUCTIONS" | jq -Rs .)
          ESCAPED_TITLE=$(echo "$ISSUE_TITLE" | jq -Rs .)
          ESCAPED_BODY=$(echo "$ISSUE_BODY" | jq -Rs .)
          
          # Make API call to GitHub Models
          RESPONSE=$(curl -s -w "\n%{http_code}" https://models.github.ai/inference/chat/completions \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [
                {\"role\": \"system\", \"content\": $ESCAPED_INSTRUCTIONS},
                {\"role\": \"user\", \"content\": \"Issue title: $ESCAPED_TITLE\n\nIssue body:\n$ESCAPED_BODY\"}
              ]
            }")
          
          # Extract HTTP status code (last line)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            CONTENT=$(echo "$RESPONSE_BODY" | jq -r '.choices[0].message.content')
            
            if [ "$CONTENT" = "null" ] || [ -z "$CONTENT" ]; then
              echo "Error: No content in API response"
              echo "$RESPONSE_BODY" | jq .
              exit 1
            fi
            
            # Save content to output
            {
              echo "CONTENT<<EOF"
              echo "$CONTENT"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "Error: API request failed with status $HTTP_CODE"
            echo "$RESPONSE_BODY" | jq .
            exit 1
          fi

      - name: Post response to issue
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          BODY: ${{ steps.generate.outputs.CONTENT }}
        run: |
          # Create JSON payload with proper escaping
          PAYLOAD=$(jq -n --arg body "$BODY" '{body: $body}')
          
          # Post comment to issue
          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/issues/$ISSUE_NUMBER/comments" \
            -d "$PAYLOAD"
