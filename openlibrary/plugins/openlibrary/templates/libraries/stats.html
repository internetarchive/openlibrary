$def with (stats)

<div id="contentHead">
    <h1>Libraries / Stats</h1>
</div>

<script type="text/javascript">

function setup_tooltip(selector, format_message) {
    format_message = format_message || function(x, y) {
        return "(" + x + ", " + y + ")";
    };

    function showTooltip(x, y, contents) {
        \$('<div id="chartLabelA">' + contents + '</div>').css({
            position: 'absolute',
            display: 'none',
            top: y + 12,
            left: x + 12,
            border: '1px solid #ccc',
            padding: '2px',
            backgroundColor: '#efefef',
            color: '#454545',
            fontSize: '11px',
            webkitBoxShadow: '1px 1px 3px #333',
            mozBoxShadow: '1px 1px 1px #000',
            boxShadow: '1px 1px 1px #000'
        }).appendTo("body").fadeIn(200);
    };

    \$(selector).bind("plothover", function (event, pos, item) {
        \$("#x").text(pos.x);
        \$("#y").text(pos.y.toFixed(0));
        if (item) {
            \$("#chartLabelA").remove();

            var x = item.datapoint[0];
            var y = item.datapoint[1];
            var msg = format_message(x, y);

            showTooltip(item.pageX, item.pageY, msg);
        } else {
            \$("#chartLabelA").remove();
        };
    });
}

\$(function () {
    \$.plot("#loans-per-day", [$:json_encode(stats.get_loans_per_day())], {
        series: {
             bars: {
                 show: true,
                 align: "left",
                 barWidth: 24 * 60 * 60 * 1000
             },
        },
         grid: {
             hoverable: true,
             show: true
         },
         xaxis: {
             mode: "time"
         }
    });

    \$.plot("#duration", [$:json_encode(stats.get_loan_duration_frequency())], {
        series: {
             bars: {
                 show: true,
                 align: "center",
             },
        },
         grid: {
             hoverable: true,
             show: true
         },
         xaxis: {
             ticks: [7, 14]
         }
    });

    setup_tooltip("#duration");

    \$.plot("#avg-duration", [$:json_encode(stats.get_average_duration_per_month())], {
        series: {
             bars: {
                 show: true,
                 align: "left",
                 barWidth: 30 * 24 * 60 * 60 * 1000
             },
        },
         grid: {
             hoverable: true,
             show: true
         },
         xaxis: {
             mode: "time"
         }
    });
});
</script>

<style type="text/css">
div.graph {
    width: 918px;
    height: 180px;
}
</style>

<div id="contentBody">
    <h2>Loans per day</h2>
    <div id="loans-per-day" class="graph"></div>

    <h2>Distribution of Loan Duration</h2>
    <div>
        x-axis: Loan duration<br/>
        y-axis: Number of loans<br/>
        <br/>
    </div>
    <div id="duration" class="graph"></div>
    
    <div>
        $ summary = stats.get_summary()
        $ total = summary['total_loans']
        $ onehour = summary['one_hour_loans']
        $ expired = summary['expired_loans']
        $ percent = lambda v: sprintf("%.2f%%", (100.0 * v)/total)

        Total Loans: $total
        <br/>
        Loans returned in less than one hour: $onehour ($percent(onehour))
        <br/>
        Expired Loans: $expired ($percent(expired))
        <br/>
    </div>

    <h2>Average Loan Duration</h2>
    <div id="avg-duration" class="graph"></div>

    <h2 class="fixthis">Loans per user</h2>

    <div>
        x-axis: Number of loans taken<br/>
        y-axis: Number of users<br/>
        <br/>
    </div>
    <div id="loans-per-user" class="graph"></div>

    <h2 class="fixthis">Popular Books</h2>
</div>