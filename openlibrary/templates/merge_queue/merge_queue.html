$def with(total, merge_requests=None)

$# total : dict : {"open": int, "closed": int}; The total number of merge requests found for the current mode
$# merge_requests : list : Merge requests to be displayed in the table

$ username = ctx.user and ctx.user.key.split('/')[-1]
$ can_merge = ctx.user and (ctx.user.is_usergroup_member('/usergroup/super-librarians'))

$ reviewer = query_param('reviewer', None)
$ submitter = query_param('submitter', None)
$ mode = query_param('mode', 'open')

$if submitter:
  $ desc = _("Showing %(username)s's requests only.", username=submitter)
  $ link_text = _('Show all requests')
  $ href = changequery(submitter=None, page=None)
$else:
  $ desc = _('Showing all requests.')
  $ link_text = _('Show my requests') if username else ''
  $ href = changequery(submitter=username, page=None) if username else changequery(submitter=None, page=None)

<div class="librarian-queue-page">
  <h1>$_('Community Edit Requests')</h1>

  <div class="description">
    $if can_merge:
      <span class="reviewer-filter">
        $if reviewer:
          $_("Showing requests reviewed by %(reviewer)s only.", reviewer=reviewer) <a href="$changequery(reviewer=None, page=None)">$_("Remove reviewer filter")</a>
        $else:
          <a href="$changequery(reviewer=username, page=None)">$_("Show requests that I've reviewed")</a>
      </span>
    <span>$desc <a href="$href">$link_text</a></span>
  </div>

$ page = int(input(page=1).page)
<div class="pager">
  $:macros.Pager(page, total[mode], results_per_page=25)
</div>
<div class="librarian-queue-wrapper">
  <ul class="table-header">
    <li class="$(mode=='open' and 'selected' or '')">
      <a href="$changequery(mode='open', page=None)">$_('Open') ($total['open'])</a>
    </li>
    <li class="$(mode=='closed' and 'selected' or '')">
      <a href="$changequery(mode='closed', page=None)">$_('Closed') ($total['closed'])</a>
    </li>
  </ul>

  <div class="table-wrapper">
    <!-- reconstruct table below --------------------------------------------->
      <table class="mr-table">
        <tbody>
        $if not merge_requests:
          <tr>
            <td colspan="5">$_('No entries here!')</td>
          </tr>
        $for r in merge_requests:
          $ work_title = r.get('title', 'an untitled work')
          $ comments = r.get('comments', {}).get('comments', [])
          $ status = get_status_for_view(r['status'])
          $ is_open = r['status'] == 1
          $ url = "%s&mrid=%s" % (r['url'], r['id'])
          $ is_submitter = username == r['submitter']
          $ type_str = _('Author') if r['mr_type'] == 2 else _('Work')
          <tr id="mrid-$(r['id'])">

            <td id="comment-cell-$(r['id'])" class="comment-cell">
              <div class="dot-wrapper"><div class="green-dot"></div></div>
              <div>
                <div class="comment-cell__summary">
                  <strong>
                    $:_('<span class="book-title">%(title)s</span>', title=work_title, type=type_str)
                  </strong>
                </div>

                <div id="hidden-comments-$r['id']" class="comment-cell__old-comments hidden">
                  $for c in comments[:-1]:
                  $:render_template('merge_queue/comment', comment=c)
                </div>
                <div class="comment-cell__newest-comment">
                  $if comments:
                    $:render_template('merge_queue/comment', comment=comments[-1])
                  $else:
                    <span>$_('No comments yet.')</span>
                </div>

                $if is_submitter or can_merge:
                  <hr>
                  <div class="comment-cell__input">
                    <textarea rows="1" placeholder="$_('Add a comment...')"></textarea>
                    <input class="mr-comment-btn" type="button" value="Reply" data-mrid="$r['id']" data-merge-type="$r['mr_type']">
                  </div>

              </div>
            </td>

            <td class="mr-comment-review-cell">
              $if is_open:
              $if is_submitter:
                <a class="mr-close-link" data-mrid="$r['id']" data-merge-type="$r['mr_type']" href="javascript:;">$_('Close')</a>
              $elif can_merge:
                $ show_link = not r.get('reviewer') or r.get('reviewer') == username
                $ extra_classes = '' if show_link else ' hidden'
                <button class="mr-comment-review-cell__review">
                  <strong>
                    <a class="mr-resolve-link$extra_classes" id="mr-resolve-link-$r['id']" data-mrid="$r['id']" data-merge-type="$r['mr_type']" href="$url" target="_blank">$_('REVIEW')</a>
                  </strong>
                </button>
                <!-- ADD COMMENT BUTTON HERE -->
                <button id="mr-comment-btn" class="mr-comment-review-cell__comments mr-comment-btn-$r['id']">
                  <a href="javascript:;" class="comment-expand" data-target-id="hidden-comments-$r['id']"
                  data-latest-comment="latest-comment-$r['id']"
                  data-btn-class="mr-comment-btn-$r['id']">
                    <span class="comment-count-$r['id']">$len(comments)</span>
                    <img style="margin-right:4px" src="/static/images/markdown/quotes.png" alt="">
                  </a>

            </td>
          </tr>
        </tbody>
      </table>
      <!-- reconstruct table above ------------------------------------------------>
  </div>
</div>
   <div class="pager">
    $:macros.Pager(page, total[mode], results_per_page=25)
  </div>
</div>
