$def with (page)
$ author_config = get_identifier_config('author')
$ mrid = query_param("mrid", None)

$var title: $page.name

$putctx("robots", "noindex,nofollow")

$:macros.HiddenSaveButton("addAuthor")

<div id="contentHead">
    $:macros.databarEdit(page)
    $if ctx.user and (ctx.user.is_admin() or ctx.user.is_super_librarian()):
        <span class="adminOnly right">
            <form method="post" id="delete-record" name="delete">
                <input type="hidden" name="_delete" value="true">
                $if mrid:
                    <input type="hidden" name="mrid" value="$mrid">
                <button type="submit" id="delete-btn">$_("Delete Record")</button>
            </form>
        </span>
    <h1>$_("Edit Author")</h1>
    $if not ctx.user:
        $:render_template("lib/not_logged")
</div>

<div id="contentBody">

    <form id="addAuthor" name="edit" method="post" action="" class="olform books">


    <div class="formElement title">
        <div class="formElement">
            <div class="label">
                <label for="name">$_("Name")</label>
                <span class="tip">
                    $:_('Please use natural order. For example: <strong>Leo Tolstoy</strong> not <strong>Tolstoy, Leo</strong>.')
                    <span class="attn"><em>* $_('Required field').</em></span>
                </span>
            </div>
            <div class="input">
                <input type="text" name="author--name" id="name" value="$page.name" required/>
            </div>
        </div>
    </div>

                <div id="about">

                    <fieldset class="major collapse">

                        <div class="formElement">
                            <div class="label">
                                <label for="wmd-input">$_("A short bio?")</label>
                                <span class="tip">$_('If you "borrow" information from somewhere, please make sure to cite the source.')</span>
                            </div>
                            <div class="input">
                                <textarea name="author--bio"
                                    class="markdown olform__input--large" id="wmd-input" rows="6">$page.bio</textarea>
                            </div>
                        </div>


                        <div class="formElement contentQuarter" id="birthDate">
                            <div class="label birthLabelAcc">
                                <label for="birth_date">$_("Date of birth")</label>
                            </div>
                            <div class="input birthInputAcc">
                                <input type="text" name="author--birth_date" id="birth_date" value="$page.birth_date"/>
                            </div>
                        </div>

                        <div class="formElement contentQuarter" id="deathDate">
                            <div class="label deathLabelAcc">
                                <label for="death_date">$_("Date of death")</label>
                            </div>
                            <div class="input deathInputAcc">
                                <input type="text" name="author--death_date" id="death_date" value="$page.death_date"/>
                            </div>
                        </div>

                        <div class="formElement contentQuarter">
                            <div class="label tipAcc">
                                <span class="tip">$_('We\'re not storing structured dates (yet) so a date like "21 May 2000" is recommended.')</span>
                            </div>
                        </div>

                        <div class="clearfix"></div>

                        $if page.date:
                            <div class="formElement contentQuarter" id="date">
                                    <div class="label dateLabelAcc">
                                        <label for="date">$_("Date")</label>
                                    </div>
                                    <div class="input deathInputAcc">
                                        <input type="text" name="author--date" id="date" value="$page.date"/>
                                    </div>
                            </div>
                            <div class="formElement contentQuarter">
                                <span class="tip">$_('This is a deprecated field. You can help improve this record by removing this date and populating the "Date of birth" and "Date of death" fields. Thanks!')</span>
                            </div>

                        <div class="clearfix"></div>
                        <div class="formElement">
                            <div class="label">
                                <label for="alternate_names">$_("Does this author go by any other names?")</label>
                                <span class="tip">$_("For example: Lev Nikolayevich Tolstoy was also known as Leo Tolstoy. Please list one name per line.")</span>
                            </div>
                            <div class="input">
                                <textarea name="author--alternate_names" id="alternate_names" rows="6">$"\n".join(page.alternate_names)</textarea>
                            </div>
                        </div>
                        <div class="label">$_("Identifiers") <a href="/help/faq/editing.en#author-identifiers-purpose"><img src="/images/icons/icon_help.png" alt="$_('Author Identifiers Purpose')"/></a> </div>
                        <div id="id-errors-author" class="note" style="display: none"></div>
                        <div id="hiddenAuthorIdentifiers"></div>
                        <div id="identifiers-display">
                            $ admin = ctx.user.is_admin() or ctx.user.is_super_librarian()
                            $:render_component('IdentifiersInput', attrs=dict(assigned_ids_string=dict(page.remote_ids),output_selector='#hiddenAuthorIdentifiers', admin=str(admin), input_prefix='author--remote_ids', id_config_string=author_config.identifiers))
                        </div>
                        <br>
                        <fieldset class="major">
                            <legend>$_("Links")</legend>
                            <div class="formBack">
                                $:render_template("books/edit/web", page, prefix="author--")
                            </div>
                        </fieldset>
                    </fieldset>

                </div>


        $:render_template("authors/infobox", page, edit_view=True)

            <div class="clearfix"></div>

            <div class="formElement bottom">
                $:macros.EditButtons(comment=page.comment_)
            </div>
    </form>
</div>

$if mrid and ctx.user:
    <div id="mr-review-panel" data-mrid="$:str(mrid)" class="hidden">
        <textarea id="mr-review-comment"></textarea>
        <button type="button" id="mr-approve-btn">$_("Approve")</button>
        <button type="button" id="mr-decline-btn">$_("Decline")</button>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const approveBtn = document.getElementById('mr-approve-btn');
    const declineBtn = document.getElementById('mr-decline-btn');
    const commentTextarea = document.getElementById('mr-review-comment');
    const reviewPanel = document.getElementById('mr-review-panel');
    
    if (approveBtn) {
        approveBtn.addEventListener('click', function() {
            const mrid = reviewPanel ? reviewPanel.getAttribute('data-mrid') : null;
            const comment = commentTextarea ? commentTextarea.value : '';
            
            console.log('=== APPROVE BUTTON CLICKED ===');
            console.log('MRID:', mrid);
            console.log('Comment:', comment);
            console.log('Current URL:', window.location.href);
            console.log('Review Panel exists:', !!reviewPanel);
            
            // Prepare the data to send
            const formData = new FormData();
            formData.append('mrid', mrid);
            formData.append('action', 'approve');
            formData.append('comment', comment);
            
            console.log('FormData contents:');
            for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }
            
            // Get the current page URL for the POST request
            const currentUrl = window.location.pathname + window.location.search;
            console.log('POST URL:', currentUrl);
            
            // Make the request
            fetch(currentUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                console.log('Response ok:', response.ok);
                
                // Log response as text first
                return response.text().then(text => {
                    console.log('Response body (raw):', text);
                    
                    // Try to parse as JSON
                    try {
                        const json = JSON.parse(text);
                        console.log('Response body (parsed JSON):', json);
                        return { status: response.status, ok: response.ok, data: json, text: text };
                    } catch (e) {
                        console.log('Response is not JSON:', e);
                        return { status: response.status, ok: response.ok, data: null, text: text };
                    }
                });
            })
            .then(result => {
                console.log('Final result:', result);
                
                if (result.ok) {
                    console.log('SUCCESS: Request completed successfully');
                    alert('Merge request approved successfully!');
                    // Redirect or reload page
                    window.location.href = result.data?.redirect || window.location.pathname;
                } else {
                    console.error('ERROR: Request failed with status', result.status);
                    console.error('Error response:', result.text);
                    alert('Error approving merge request. Check console for details.');
                }
            })
            .catch(error => {
                console.error('=== FETCH ERROR ===');
                console.error('Error type:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                alert('Network error: ' + error.message);
            });
        });
    }
    
    if (declineBtn) {
        declineBtn.addEventListener('click', function() {
            const mrid = reviewPanel ? reviewPanel.getAttribute('data-mrid') : null;
            const comment = commentTextarea ? commentTextarea.value : '';
            
            console.log('=== DECLINE BUTTON CLICKED ===');
            console.log('MRID:', mrid);
            console.log('Comment:', comment);
            
            const formData = new FormData();
            formData.append('mrid', mrid);
            formData.append('action', 'decline');
            formData.append('comment', comment);
            
            const currentUrl = window.location.pathname + window.location.search;
            
            fetch(currentUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('Decline response status:', response.status);
                return response.text().then(text => {
                    try {
                        return { status: response.status, ok: response.ok, data: JSON.parse(text), text: text };
                    } catch (e) {
                        return { status: response.status, ok: response.ok, data: null, text: text };
                    }
                });
            })
            .then(result => {
                console.log('Decline result:', result);
                
                if (result.ok) {
                    alert('Merge request declined successfully!');
                    window.location.href = result.data?.redirect || window.location.pathname;
                } else {
                    console.error('Decline error:', result.text);
                    alert('Error declining merge request. Check console for details.');
                }
            })
            .catch(error => {
                console.error('Decline fetch error:', error);
                alert('Network error: ' + error.message);
            });
        });
    }
    
    // Log initial state
    console.log('=== MERGE REQUEST REVIEW PANEL INITIALIZED ===');
    console.log('Approve button exists:', !!approveBtn);
    console.log('Decline button exists:', !!declineBtn);
    console.log('Comment textarea exists:', !!commentTextarea);
    console.log('Review panel exists:', !!reviewPanel);
    if (reviewPanel) {
        console.log('MRID from panel:', reviewPanel.getAttribute('data-mrid'));
    }
});
</script>