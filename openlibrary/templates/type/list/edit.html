$def with (lst, new=False, action=None, list_type='list')
$putctx('cssfile', 'list-edit')

$code:
    if list_type == 'series':
        title = _("Create a series") if new else _("Editing series: %(list_name)s", list_name=lst.name)
    else:
        title = _("Create a list") if new else _("Editing list: %(list_name)s", list_name=lst.name)

$var title: $title

$putctx("robots", "noindex,nofollow")

$ can_save = True

<div id="contentHead">
    $if not new:
        $:macros.databarEdit(lst)
    <h1>
        $if list_type == 'series':
            $(_("Create a series") if new else _("Edit Series"))
        $else:
            $(_("Create a list") if new else _("Edit List"))
    </h1>
</div>

$# Render the ith seed input field
$jsdef render_seed_field(i, seed):
    $# seed['key'] errors in python; seed.get('key') errors in js. So need
    $# to run different code on the server and client.
    $if jsdef_get(seed, 'key') != None:
        $ seed = { 'thing': seed, 'notes': '' }

    $ key = ''
    $if seed['thing']:
        $ key = seed['thing']['key']

    <li class="mia__input ac-input">
        <div class="seed--controls">
            $# detect-missing-i18n-skip-line
            <div class="mia__reorder mia__index">â‰¡ #$(i + 1)</div>
            <button class="mia__move" type="button">$_("Move...")</button>
            <button class="mia__remove" type="button">$_("Remove")</button>
        </div>
        <main>
            <input class="ac-input__value" name="seeds--$i--thing--key" type="hidden" value="$key" />
            $# Displayed
            <input
                class="ac-input__visible"
                value="$key.split('/')[-1]"
                placeholder="$_('Search for a book')"
                $if key:
                    type="hidden"
            />

            <div class="ac-input__preview">
                $# Note: Cannot use "in" because this is a jsdef function
                $if key:
                    $ prefix = key.split('/')[1]
                    $if prefix == 'works' or prefix == 'books':
                        $:lazy_thing_preview(key, 'render_lazy_work_preview')
                    $elif prefix == 'authors':
                        $:lazy_thing_preview(key, 'render_lazy_author_preview')
                    $else:
                        $key
                $else:
                    $key
            </div>

            $# Position only renders for series; but this jsdef method doesn't know whether we're on
            $# a series page or not, so, rather awkwardly, the rendering of this is controlled by the
            $# CSS class.
            <div class="floating-label le__position">
                <span class="floating-label__text">$_('Position (optional), e.g. 1, 2, 1-7')</span>
                <input
                    class="floating-label__input"
                    name="seeds--$i--position"
                    placeholder="$_('Position (optional), e.g. 1, 2, 1-7')"
                    value="$(jsdef_get(seed, 'position') or '')"
                >
            </div>

            <div class="floating-label le__notes">
                <span class="floating-label__text">$_('Notes (optional)')</span>
                <textarea
                    class="floating-label__input"
                    name="seeds--$i--notes"
                    placeholder="$_('Notes (optional)')"
                >$(jsdef_get(seed, 'notes') or '')</textarea>
            </div>
        </main>
    </li>

$# import the side-effect of the jsdef function
$:render_template('jsdef/LazyWorkPreview', None)
$:render_template('jsdef/LazyAuthorPreview', None)

$jsdef lazy_thing_preview(key, render_fn_name):
    <div class="lazy-thing-preview" data-key="$key" data-render-fn="$render_fn_name">
        $if not is_jsdef():
            $ prefix = key.split('/')[1]
            $if prefix == 'works' or prefix == 'books':
                $code:
                    fake_book = {
                        'key': key,
                        'title': '...',
                        'full_title': '...',
                        'author_name': ['...'],
                        'edition_count': '_',
                        'cover_i': None,
                    }
                $:render_template('jsdef/LazyWorkPreview', fake_book)
            $elif prefix == 'authors':
                $code:
                    fake_author = {
                        'key': key,
                        'name': '...',
                        'birth_date': None,
                        'death_date': None,
                        'work_count': '_',
                        'top_work': ['...'],
                        'subjects': ['...'],
                    }
                $:render_template('jsdef/LazyAuthorPreview', fake_author)
    </div>

<div id="contentBody">
    <form
        method="post"
        id="list-edit"
        class="olform list-edit--$list_type"
        $:cond(action, 'action="%s"' % action)
    >
        $if not new:
            <input
                required
                type="hidden"
                name="key"
                value="$lst.key"
            />

        <div class="floating-label">
            <span class="floating-label__text">$(_('List Name') if list_type == 'list' else _('Series Name'))</span>
            <input
                class="floating-label__input"
                required
                placeholder="$(_('List Name') if list_type == 'list' else _('Series Name'))"
                name="name"
                value="$lst.name"
            />
        </div>

        <div>
            <textarea
                placeholder="$_('Description (optional)')"
                class="markdown"
                name="description"
                rows="3" cols="30"
            >$lst.description</textarea>
        </div>

        <hr />

        <ol class="list-edit__items multi-input-autocomplete multi-input-autocomplete--seeds">
            $if lst.seeds:
                $for i, seed in enumerate(lst.seeds):
                    $if isinstance(seed, str):
                        $ seed = {'key': '/subjects/' + seed}
                    $:render_seed_field(i, seed)
            $else:
                $:render_seed_field(0, {'key': ''})
            <a href="javascript:;" class="mia__add">$_('Add another book')</a>
        </ol>

        <hr />

        <div class="formElement bottom">
            $if new:
                <button type="submit" class="larger" $cond(not can_save, 'disabled')>$_('Create new list')</button>
                <a href="javascript:;" class="cancel go-back-link">$_("Cancel")</a>
            $else:
                $:macros.EditButtons(comment=lst.comment_)
        </div>
    </form>
</div>
