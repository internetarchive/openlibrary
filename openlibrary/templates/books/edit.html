$def with (work, edition=None, recaptcha=None)

$ work_config = get_identifier_config('work')
$ this_title = work.title + ': ' + work.subtitle if work.get('subtitle', None) else work.title
$ mrid = query_param("mrid", [None])[0]

$var title: $this_title
$putctx("robots", "noindex,nofollow")

$:macros.HiddenSaveButton("addWork")

<div id="contentHead">
    $code:
        def find_mode():
            mode = query_param("mode")
            if not edition or not work.key:
                return "other"
            if mode == "found":
                return "existing_record"
            if mode == "add-work" and work.revision == 1 and work.edition_count == 1 and edition.revision == 1:
                return "new_work"
            if mode == "add-book" and edition.revision == 1:
                return "new_edition"
            return "other"

        mode = find_mode()
        if mode == "new_work":
            title = _("Add a little more?")
            note = '<p class="alert thanks">' + _("Thank you for adding that book! Any more information you could provide would be wonderful!") + "</p>"
        elif mode == "new_edition":
            title = _("Add a little more?")
            note = '<p class="alert thanks">' + _("We already know about <b>%(work_title)s</b>, but not the <b>%(year)s %(publisher)s edition</b>. Thanks! Do you know any more about this edition?", work_title=work.title, year=edition.publish_date, publisher="; ".join(edition.publishers)) + "</p>"
        elif mode == "existing_record":
            title = _("Add a little more?")
            note = '<p class="alert info">' + _("We already know about the <b>%(year)s %(publisher)s edition</b> of <b>%(work_title)s</b>, but please, tell us more!", year=edition.publish_date, publisher="; ".join(edition.publishers), work_title=work.title) + "</p>"
        else:
            title = _("Editing...")
            note = ""

    $:macros.databarEdit(edition if edition is not None else work)

    $if ctx.user and (ctx.user.is_admin() or ctx.user.is_super_librarian()):
        <span class="adminOnly right">
            <form method="post" id="delete-record" name="delete">
                <input type="hidden" name="_delete" value="true">
                $if mrid:
                    <input type="hidden" name="mrid" value="$mrid">
                <button type="button" id="delete-btn">$_("Delete Record")</button>
            </form>
        </span>

    <h2 class="editFormTitle">$:title</h2>
    $if not ctx.user:
        $:render_template("lib/not_logged")
    $:note
</div>

<div id="contentBody">
    $ work_key = query_param('work_key', None)
    $ action = '?work_key=%s' % work_key if work_key else ''
    <form method="post" id="addWork" class="olform books" name="edit" action="$action">

        <input type="hidden" name="work--key" value="$work.key">
        $ authors = work.authors and [a.author for a in work.authors]
        <h1 class="editFormBookTitle">$this_title</h1>
        $if authors:
            <h3 class="editFormBookAuthors">
                $ is_librarian = ctx.user and ctx.user.is_librarian()
                $:macros.BookByline([{'name': a.name, 'url': a.url(), 'birth_date': a.birth_date, 'death_date': a.death_date} for a in authors], show_years=is_librarian)
            </h3>
        <div class="ol-tabs">
            <ul>
                <li><a href="#about" id="link_about">$_("Work Details")</a></li>
                $if edition:
                    $if edition.publishers:
                        $ edition_name = "; ".join(edition.publishers) + ' edition'
                    $else:
                        $ edition_name = _('Unknown publisher edition')

                    $if edition.publish_date:
                        $ edition_name = truncate(edition_name, 20) + ", " + edition.publish_date

                    <li><a href="#edition" id="link_edition">$edition_name</a></li>
            </ul>

            <div id="about">
                <fieldset class="major">
                    <legend>$_("This Work")</legend>
                    <div class="formBack">
                        <div class="formElement formBackLeft">
                            <div class="formElement title">
                                <div class="TitleAuthor sansserif">
                                    <div class="label">
                                        <label for="work-title">$_('Title')</label>
                                        <span class="red">*</span>
                                    </div>
                                    <div class="input">
                                        <input name="work--title" type="text" id="work-title" value="$this_title" required/>
                                    </div>
                                    <div class="label">
                                        <label for="author-$0">$_("Author")</label>
                                    </div>
                                    $:render_template("books/author-autocomplete", authors, "authors", "work--authors")
                                </div>
                            </div>
                            $:render_template("books/edit/about", work)
                        </div>
                    </div>
                </fieldset>
                <fieldset class="major">
                    <legend>$_("Add Excerpts")</legend>
                    <div class="formBack" id="excerpts">
                        $:render_template("books/edit/excerpts", work)
                    </div>
                </fieldset>
                <fieldset class="major">
                    <legend>$_("Links")</legend>
                    <div class="formBack">
                        $:render_template("books/edit/web", work, prefix="work--")
                    </div>
                </fieldset>
                <fieldset class="major" id="identifiers">
                    <legend>$_("Work Identifiers")</legend>
                    <div class="formBack">
                        <div id="hiddenWorkIdentifiers"></div>
                        <div id="identifiers-display-works">
                            $ admin = str(bool(ctx.user) and (ctx.user.is_admin() or ctx.user.is_super_librarian()))
                            $:render_component('IdentifiersInput', attrs=dict(assigned_ids_string=work.get_identifiers().values(), output_selector='#hiddenWorkIdentifiers', id_config_string=work_config.identifiers, input_prefix='work--identifiers', multiple='true', admin=admin))
                        </div>
                    </div>
                </fieldset>
            </div>

            $if edition:
                <div id="edition">
                    $:render_template("books/edit/edition", work, edition)
                </div>
        </div>

        $if recaptcha:
            $:render_template("recaptcha", recaptcha.public_key, error=None)

        $:macros.EditButtons(comment=work.comment_)
    </form>
</div>

$if mrid and ctx.user:
    <div id="mr-review-panel" data-mrid="$mrid" class="hidden">
        <textarea id="mr-review-comment"></textarea>
        <button type="button" id="mr-approve-btn">$_("Approve")</button>
        <button type="button" id="mr-decline-btn">$_("Decline")</button>
    </div>

