$def with (page, include_rating=True, include_header=True, include_widget=True, include_showcase=True, read_status=None, exclude_own_lists=False, async_load=False, show_active_lists=False)

$ edition = page if page.key.startswith("/books/") else None
$ work = (page.works and page.works[0]) if page.key.startswith("/books/") else page if page.key.startswith("/works/") else None
$ username = ctx.user and ctx.user.key.split('/')[-1]
$ users_work_read_status = read_status or work.get_users_read_status(username) if work and username else None

<div class="lists-widget-container">
$if "lists" not in ctx.features:
    $return

$code:
    def get_page_lists(page, seed_info):
        return [get_list_data(list, seed_info['seed']) for list in page.get_lists(sort=False)]

$ seed_info = get_seed_info(page)
$ user_lists = [] if async_load or not ctx.user else get_user_lists(seed_info)
$ page_lists = get_page_lists(page, seed_info)
$ user_key = ctx.user and ctx.user.key
$ page_url = page.url()

$var page_lists = page_lists

$def render_already_lists(lists, user_key):
    $for list in lists:
        $if list['active']:
            $:render_template('lists/list_overview', list, user_key, seed_info)

$def render_widget_display(lists, limit, user_key):
    $ count = 0
    $for i, list in enumerate(lists):
        $if count < limit:
          $ own_list = list.owner and list.owner.key == user_key
          $ converted = convert_list(list.key)
          $:list_card(converted, list.owner, own_list) 
          $ count = count + 1


$def list_card(list, owner, own_list):
    $ has_owner = owner
    $ cached_info = list.get_patron_showcase()
    $ count = cached_info["count"]
    <div class="list-card" >
        <a class="list-card__covers" href="$list.get_url()">
            $for img_url in cached_info["covers"]:
                $if img_url:
                    $ img_url = img_url.replace("-S.jpg", "-M.jpg")
                $else:
                    $ img_url = '/images/icons/avatar_book-sm.png'
                <img src="$img_url" loading="lazy" width="80"/>
        </a>
          <div class="list-card__name-tag">
            <div class="list-card__name-avatar">
              <a href="$owner.key">
                <img src="$(owner.key)/avatar" class="list-card__avatar"/>
              </a>
              <div class="list-card__text">
               <div class="list-card__title">$cached_info["title"]</div>
               <div class="list-card__num-books">
                 $ungettext("%(count)d book", "%(count)d books", count, count=count)
               </div>
               $if not own_list:
                <div class="list-card__num-books">
                  follow $(owner.displayname)
                </div>
              </div>
            </div>
          </div>
    </div>

$def render_head(page_lists, page_url):
    <div>
      <h3 class="header">
        <span class="icon list heart-adjust"></span>
        $if len(page_lists) > 0:
            <span class="head"><a href="$page_url/lists">$ungettext("%(count)d List", "%(count)d Lists", len(page_lists), count=len(page_lists))</a></span>
        $else:
            <span class="head">$_("Lists")</span>
      </h3>
    </div>

$if include_header:
  <div class="lists-widget-head">
    $:render_head(page_lists, page_url)
  </div>

$ default_seed_key = seed_info['seed']['key'] if isinstance(seed_info['seed'], dict) else seed_info['seed']

$def i18n_input():
  $ show_list_i18n_strings = {
    $ "cover_of": _('Cover of: %(title)s', title=''),
    $ "see_this_list": _('See this list'),
    $ "remove_from_list": _('Remove from your list?'),
    $ "from": _('from'),
    $ "you": _('You')
    $ }
  <input type="hidden" name="list-i18n-strings" value="$json_encode(show_list_i18n_strings)">

$if include_widget:
  $if render_once('lists/widget.i18n-strings'):
    $:i18n_input()

  $:render_template('my_books/dropper', page, async_load=async_load)

  $if username and show_active_lists:
    <ul class="listLists already-lists">
        $if async_load:
          <div class="list-overview-loading-indicator">$:_('Loading<span class="loading-ellipsis">...</span>')</div>
        $else:
          $:render_already_lists(user_lists, user_key)
    </ul>
  $if work and include_rating:
    $:macros.StarRatings(work, edition)

$if include_showcase:    
  <div class="carousel-section">
    <div class="list-showcase">
      $:render_widget_display(page_lists, 5, user_key )
      $if len(page_lists) > 5:
          <a
            class="list-showcase__see-all cta-btn cta-btn--vanilla"
             href="$page.url()/lists"
            >$_("See all")</a>
    </div>
  </div>
</div>
