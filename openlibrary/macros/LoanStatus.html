$def with (page, user, editions_page=False, block_name='', render_preview_floater=True, work_key=None)
$# Takes following parameters:
$# * page
$# * user
$# * editions_page renders additional data if you're seeing LoanStatus rendered in the sidebar of an edition page v. in the work's table.
$# * block_name is a BEM block name
$# * render_preview_floater whether to render the HTML for the preview floater

$ loanstatus_start_time = time()

$ ocaid = page.get('ocaid') or page.availability.get('identifier')
$ work_key = work_key or (page.works and page.works[0].key)
$ user_loan = None
$ waiting_loan = ctx.user and ctx.user.get_waiting_loan_for(page)
$ my_turn_to_borrow = waiting_loan and waiting_loan['status'] == 'available' and waiting_loan['position'] == 1
$ current_and_available_loans = []

$ availability = page.availability.get('status')

$ lending_st = {}
$if editions_page and (page.availability.get('is_browseable', False) or availability == 'borrow_unavailable'):
  $ lending_st = get_cached_groundtruth_availability(ocaid)

$ is_lendable = lending_st.get('is_lendable', False) or page.availability.get('is_lendable', False)
$# there could be exception where ocaid insufficient because is_restricted but not printdisabled
$# ^ This will be resolved when Jude adds 'access-restricted-item' check
$ is_printdisabled = lending_st.get('is_printdisabled', False) or page.availability.get('is_printdisabled', False)
$ is_borrowable = lending_st.get('available_to_borrow') or lending_st.get('available_to_browse') or availability == 'borrow_available' or my_turn_to_borrow
$ is_restricted = page.availability.get('is_restricted', False)
$ is_open = page.availability.get('is_readable', False)

$if ocaid and page.key.startswith('/book'):
  $ current_and_available_loans = page.get_current_and_available_loans()
  $ user_loan = None
  $if ctx.user:
    $for current_loan in current_and_available_loans[0]:
      $if current_loan['user'] == ctx.user.key:
        $ user_loan = current_loan
        $ break

$ current_loans = current_and_available_loans[0] if current_and_available_loans else []

$if user:
    $for current_loan in current_loans:
        $if current_loan['user'] == user.key:
            $ user_loan = current_loan
            $ break

$if page.key.startswith('/book') and user_loan:
  $:macros.ReadButton(ocaid, loan=user_loan, listen=True)
  $ return_url = page.url().rsplit('/', 1)[0] + '/do_return/borrow'
  <form action="$return_url" method="post" class="waitinglist-form return-book">
    <input type="hidden" name="action" value="return" />
    <input type="submit" value="$_('Return eBook')" class="cta-btn cta-btn--available" id="return_ebook"/>
  </form>

$elif editions_page and ocaid and is_restricted and not is_lendable:
  <div class="cta-button-group">
    <a href="$work_key" class="cta-btn cta-btn--missing"
       data-ol-link-track="CTAClick|NotInLibrary">$_('Not in Library')</a>
  </div>


$elif ocaid and is_open:
  $:macros.ReadButton(ocaid, listen=True)
  $if editions_page:
    $:macros.BookSearchInside(ocaid)

$elif ocaid and is_lendable:
  $ borrow_link = '/ia/%s/borrow' % ocaid
  $if is_borrowable:
    $:macros.ReadButton(ocaid, borrow=True, listen=True)
  $elif lending_st.get('available_to_waitlist', False):
    $# lending_st is the only API which accurately tells us if a book is waitlistable
    $ wlsize = lending_st.get('users_on_waitlist') or page.get('availability', {}).get('num_waitlist')
    $if waiting_loan:
      <p class="waitinglist-message">
        $ spot = ctx.user.get_waiting_loan_for(page)['position']
        $if spot == 1:
          $:_('You are <strong>next</strong> on the waiting list')
        $else:
          $:_('You are <strong>#%(spot)d</strong> of %(wlsize)d on the waiting list.', spot=spot, wlsize=wlsize)
      </p>
      <form method="POST" action="$borrow_link" class="leave-waitlist waitinglist-form">
        <input type="hidden" name="action" value="leave-waitinglist"/>
        <input type="submit" class="cta-btn" id="unwaitlist_ebook"
               value="$_('Leave waiting list')"/>
      </form>
    $else:
      $# "JOIN-WAITLIST" button
      <p class="waitinglist-message">
        $if wlsize:
          $_("Readers waiting for this title: %(count)d", count=wlsize)
        $else:
          $_("You'll be next in line.")
      </p>
      <form method="POST" action="$borrow_link" class="join-waitlist waitinglist-form">
        <input type="hidden" name="action" value="join-waitinglist"/>
        <input type="submit" class="cta-btn cta-btn--unavailable" id="waitlist_ebook" value="$_('Join Waitlist')"/>
      </form>
  $elif availability == 'borrow_unavailable':
    $# This _used_ to mean that the book was waitlistable, but no longer! Now show this little cop-out button
    <div class="cta-button-group">
      <a href="/ia/$(ocaid)" class="cta-btn cta-btn--available" title="$_('We were unable to determine the availability of this book! Click to check on Internet Archive.')"
         data-ol-link-track="CTAClick|CheckAvailability">$_('Check Availability')</a>
    </div>
  $else:
    <div class="cta-button-group">
      <a href="$work_key" class="cta-btn cta-btn--missing" title="$_('This book is currently checked out, please check back later.')"
         data-ol-link-track="CTAClick|CheckedOut">$_('Checked Out')</a>
    </div>

$elif page.key.startswith('/book') and not ocaid or editions_page and not is_lendable:
  $ sponsorship = qualifies_for_sponsorship(page)
  $if sponsorship.get('is_eligible'):
    $ isbn = (page.isbn_13 and page.isbn_13[0] or page.isbn_10 and page.isbn_10[0])
    <a href="$(sponsorship['sponsor_url'])"
       class="cta-btn cta-btn--sponsor"
       data-ol-link-track="CTAClick|Sponsor">$_('Sponsor eBook')</a>
    <p>
      $_("We don't have this book yet. You can add it to our Lending Library with a %(price)s tax deductible donation.", price=sponsorship['price']['total_price_display'])
      <a href="/sponsorship" target="_blank">$_('Learn More')</a>
    </p>
  $else:
    <a href="$work_key" class="cta-btn cta-btn--missing" data-ol-link-track="CTAClick|NotInLibrary">$_('Not in Library')</a>

$if ocaid:
  $if editions_page and is_printdisabled:
    $:macros.BookPreview(ocaid, render_preview_floater)
  $:macros.daisy(page, url='/ia/%s/daisy' % ocaid, protected=is_printdisabled, block_name=block_name)

$if query_param('debug'):
  $ loanstatus_end_time = time() - loanstatus_start_time
  <p>LoanStatus took $("%.2f" % loanstatus_end_time) seconds</p>
  $lending_st $page.availability
