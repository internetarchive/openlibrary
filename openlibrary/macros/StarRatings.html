$def with (work, edition=None, redir_url=None, id='', rating=None)

$ username = ctx.user and ctx.user.key.split('/')[-1]
$if rating is None and work and username:
  $ rating = work.get_users_rating(username)
$ edition_key = edition.key if edition else ""
$ work_id = work.key.split('/')[-1] if work else ""

<!-- TODO: Analytics tracking needs to be reimplemented.
     Previous implementation used: data-ol-link-track="StarRating|BookRated"
     This needs to be integrated with the component's change event handler. -->

<ol-star-rating
  id="starRating$id"
  value="$(rating if rating else 0)"
  clear-button-label="$_('Clear my rating')"
></ol-star-rating>

<script>
(function() {
  const starRating = document.getElementById('starRating$id');
  if (!starRating) return;

  const workKey = '$work.key';
  const editionKey = '$edition_key';
  const workId = '$work_id';

  // Handle rating changes
  starRating.addEventListener('change', async (event) => {
    const rating = event.detail.value;

    try {
      const formData = new URLSearchParams();

      // Only send rating parameter if rating is not 0 (clearing)
      if (rating !== 0) {
        formData.append('rating', rating.toString());
      }

      if (editionKey) {
        formData.append('edition_id', editionKey);
      }

      formData.append('ajax', 'true');

      const response = await fetch(`$${workKey}/ratings.json`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData.toString(),
        credentials: 'same-origin'
      });

      // Handle redirect to login page
      if (response.redirected || response.status === 401) {
        const loginUrl = `/account/login?redirect=$${encodeURIComponent(window.location.pathname)}`;
        window.location.href = loginUrl;
        return;
      }

      // TODO: Add analytics tracking here
      // Example: if (window.dataLayer) { window.dataLayer.push({...}); }

    } catch (error) {
      console.error('Failed to submit rating:', error);
      // Optionally revert the UI on error
      starRating.value = event.target._previousValue || 0;
    }
  });

  // Store previous value for error recovery
  starRating.addEventListener('change', (event) => {
    event.target._previousValue = event.detail.value;
  }, { capture: true });
})();
</script>
