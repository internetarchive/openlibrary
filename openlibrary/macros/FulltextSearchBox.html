$def with(query, results, page=1)


$if results and results.get('hits'):
  $ hits = results['hits'].get('hits', [])
  $ num_found = results['hits'].get('total', 0)
  $ ia_base_url = "https://archive.org"
  <div id="searchResults">
    <div>Browse $num_found Search Inside Matches</div>
    <ul class="list-books">
      $for doc in hits:
      $ ia = doc.get('fields', {}).get('identifier', [''])[0]
      $ snippets = doc.get('highlight', {}).get('text', [''])
      $ page_nums = doc.get('fields', {}).get('page_num', [])
      $ page = ', '.join([str(num) for num in page_nums])
      $ title = doc.get('fields', {}).get('meta_title', [''])[0]
      $ author_info = doc.get('fields', {}).get('meta_creator', [''])[0].split(', ')
      $ author_name = author_info[0] if author_info else ''

      $if snippets:
        <section class="fulltext-excerpts">
          <div>$title by $author_name $author_info</div>
          <span class="bookcover">
            $ cover = "%s/services/img/%s" % (ia_base_url, ia)
            <a href="$ia_base_url/details/$ia">
              <img itemprop="image"
                src="$cover"
              />
            </a>
         </span>
          <ul>
            $for snippet in snippets:
              $if snippet:
                <li class="fulltext-excerpt">
                    &hellip;$:(snippet.replace("<", "&laquo;").replace(">", "&raquo;").replace("{{{", "<mark class='highlight'><strong>").replace("}}}", "</strong></mark>"))&hellip;
                </li>
          </ul>
        </section>
    </ul>
  </div>
