services:
  web:
    image: "${OLIMAGE:-oldev:latest}"
    environment:
      - OL_CONFIG=${OL_CONFIG:-/openlibrary/conf/openlibrary.yml}
      - GUNICORN_OPTS=${GUNICORN_OPTS:- --reload --workers 4 --timeout 180}
      - OL_COVERSTORE_PUBLIC_URL=${OL_COVERSTORE_PUBLIC_URL:-}
    command: docker/ol-web-start.sh
    ports:
      - ${WEB_PORT:-8080}:8080
    networks:
      - webnet
      - dbnet
    logging:
      options:
        max-size: "512m"
        max-file: "4"

  solr:
    image: solr:9.5.0
    ports:
      - "8983:8983"  # Map Solr to host for debugging
    environment:
      - SOLR_OPTS=
        -Dsolr.autoSoftCommit.maxTime=60000
        -Dsolr.autoCommit.maxTime=120000
        -Dsolr.max.booleanClauses=30000
    volumes:
      - solr-data:/var/solr
      - ./conf/solr:/opt/solr/server/solr/configsets/olconfig:ro
    networks:
      - webnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8983/solr"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: solr-precreate openlibrary /opt/solr/server/solr/configsets/olconfig

  memcached:
    image: memcached
    command: memcached -m 256  # Increase memory allocation
    networks:
      - webnet
    healthcheck:
      test: ["CMD", "echo", "stats | nc localhost 11211"]
      interval: 30s
      timeout: 10s
      retries: 3

  covers:
    image: "${OLIMAGE:-oldev:latest}"
    environment:
      - COVERSTORE_CONFIG=${COVERSTORE_CONFIG:-/openlibrary/conf/coverstore.yml}
      - GUNICORN_OPTS=${GUNICORN_OPTS:- --reload --workers 1 --max-requests 250}
    command: docker/ol-covers-start.sh
    expose:
      - 7075
    networks:
      - webnet
      - dbnet
    logging:
      options:
        max-size: "512m"
        max-file: "4"

  infobase:
    image: "${OLIMAGE:-oldev:latest}"
    environment:
      - INFOBASE_CONFIG=${INFOBASE_CONFIG:-/openlibrary/conf/infobase.yml}
      - INFOBASE_OPTS=${INFOBASE_OPTS:-}
    command: docker/ol-infobase-start.sh
    expose:
      - 7000
    networks:
      - webnet
      - dbnet
    logging:
      options:
        max-size: "512m"
        max-file: "4"

networks:
  webnet:
  dbnet:
volumes:
  solr-data:
  solr-updater-data:
