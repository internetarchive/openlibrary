# Needed for IP anonymization
load_module modules/ngx_http_js_module.so;

user  www-data;

# XXX-Anand: Oct 2013
# Increased the worker_processes to allow more workers to share the load of https.

#worker_processes  1;
worker_processes 4;


error_log  /var/log/nginx/error.log;
pid        /var/run/nginx.pid;

events {
    worker_connections  2048;
    # multi_accept on;
}

http {
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_session_cache   shared:SSL:50m;
    ssl_session_timeout 10m;

    include       /etc/nginx/mime.types;

    server_names_hash_bucket_size   64;
    types_hash_bucket_size 64;

    # Logging / IP Anonymization; also need logging_periodics.conf inside a server block
    include /olsystem/etc/nginx/logging.conf;
    access_log    /var/log/nginx/access.log iacombined;

    js_shared_dict_zone zone=crawler_ips:10M type=number timeout=300s;
    js_import /olsystem/etc/nginx/tagger.js;

    client_max_body_size 50m;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;
    tcp_nodelay        on;

    gzip  on;
    gzip_disable "MSIE [1-6]\.(?!.*SV1)";
    gzip_types       text/plain text/css application/x-javascript application/javascript application/xml application/json;

    # Black-listed IPs
    include /olsystem/etc/nginx/deny.conf;

    # Rate limiting: https://nginx.org/en/docs/http/ngx_http_limit_req_module.html
    # These rules only do anything if invoked, e.g., in web_nginx.conf.
    # TLDR: these rules can be disabled in `docker/web_nginx.conf`
    # and `docker/covers_nginx.conf`.

    include /olsystem/etc/nginx/is_blessed_ip.conf;  # Provides $is_blessed_ip
    include /olsystem/etc/nginx/is_blessed_ua.conf;  # Provides $is_blessed_ua
    include /olsystem/etc/nginx/is_sus_ip.conf;  # Provides $is_sus_ip

    map "$is_blessed_ip:$is_blessed_ua" $rate_limit_key {
      "0:0" $binary_remote_addr;  # Rate-limit by IP
      default '';  # Don't rate-limit
    }

    # check if user-agent provides a means of identification
    map $http_user_agent $is_identifying_ua {
        default 0;
        "~*bot" 1;
        "~*spider" 1;
        "~*crawl" 1;
        "~*google" 1; # sometimes just GoogleOther
        "~*http" 1;   # Includes url
        "~*@" 1;      # Includes email
     }

    js_set $has_hit_crawler_links tagger.check;

    # The only crawlers we want to limit are the ones that don't identify themselves as such
    map "$is_blessed_ip:$is_identifying_ua:$has_hit_crawler_links:$is_sus_ip" $global_nonidentifying_crawler_rate_limit_key {
        default '';  # No shared rate limiting
        # Shared rate limit
        "0:0:1:0" 1;
        "0:0:1:1" 1;
        "0:0:0:1" 1;
    }

    # Limit the crawlers that scrape links but don't ID themselves globally
    limit_req_zone $global_nonidentifying_crawler_rate_limit_key zone=global_crawler_limit:5m rate=20r/s;

    # Matches other sites
    limit_req_zone $rate_limit_key zone=web_limit:10m rate=1r/s;
    # Higher rate for APIs since they are cheaper and we often hit them
    # multiple times per page load.
    limit_req_zone $rate_limit_key zone=api_limit:10m rate=180r/m;
    # Set a more permissive limit for covers because some pages might load 20+ covers.
    limit_req_zone $rate_limit_key zone=cover_limit:10m rate=400r/m;
    limit_req_zone $global_nonidentifying_crawler_rate_limit_key zone=global_crawler_cover_limit:5m rate=150r/s;

    # Things are mounted into here by the docker compose file
    include /etc/nginx/sites-enabled/*;
}
